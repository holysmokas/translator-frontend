<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Join Room | Mamnoon.ai</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ</text></svg>">
    <style>
        .join-page {
            min-height: 100vh;
            background: var(--gray-950);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        
        @media (max-width: 768px) {
            .join-page {
                padding: 16px;
            }
        }
        
        .join-card {
            background: var(--gray-900);
            border: 1px solid var(--gray-800);
            border-radius: 20px;
            padding: 40px;
            max-width: 450px;
            width: 100%;
            text-align: center;
        }
        
        .join-logo {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .join-title {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
        }
        
        .join-subtitle {
            color: var(--gray-400);
            margin-bottom: 32px;
        }
        
        .room-info {
            background: var(--gray-800);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .room-code-display {
            font-size: 32px;
            font-weight: 700;
            font-family: monospace;
            letter-spacing: 4px;
            color: var(--primary-light);
            margin-bottom: 8px;
        }
        
        .room-host {
            color: var(--gray-400);
            font-size: 14px;
        }
        
        .join-form {
            text-align: left;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: var(--gray-300);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            background: var(--gray-800);
            border: 1px solid var(--gray-700);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-group select {
            cursor: pointer;
        }
        
        .join-btn {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            margin-top: 8px;
        }
        
        .join-features {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--gray-800);
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--gray-400);
            font-size: 13px;
        }
        
        .feature-item .icon {
            color: var(--success);
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .room-not-found {
            padding: 60px 40px;
        }
        
        .room-not-found .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .room-not-found h2 {
            font-size: 24px;
            color: white;
            margin-bottom: 12px;
        }
        
        .room-not-found p {
            color: var(--gray-400);
            margin-bottom: 24px;
        }
        
        .enter-code-form {
            display: flex;
            gap: 12px;
            max-width: 300px;
            margin: 0 auto;
        }
        
        .enter-code-form input {
            flex: 1;
            padding: 12px 16px;
            background: var(--gray-800);
            border: 1px solid var(--gray-700);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
        }
        
        .powered-by {
            margin-top: 32px;
            color: var(--gray-500);
            font-size: 12px;
        }
        
        .powered-by a {
            color: var(--primary-light);
            text-decoration: none;
        }
        
        /* Waiting Lobby */
        .waiting-lobby {
            text-align: center;
        }
        
        .waiting-animation {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
        }
        
        .waiting-icon {
            font-size: 40px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }
        
        .pulse-ring {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 3px solid var(--primary);
            border-radius: 50%;
            animation: pulse 2s ease-out infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(0.8);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        .waiting-lobby h2 {
            color: white;
            font-size: 24px;
            margin-bottom: 12px;
        }
        
        .waiting-lobby p {
            color: var(--gray-400);
            margin-bottom: 24px;
        }
        
        .host-info {
            background: var(--gray-800);
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 16px;
            color: var(--gray-300);
        }
        
        .host-info span:last-child {
            color: white;
            font-weight: 500;
        }
        
        .room-code-badge {
            display: inline-block;
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            color: var(--primary-light);
            margin-bottom: 24px;
        }
        
        .room-code-badge span {
            font-weight: 600;
            font-family: monospace;
            letter-spacing: 2px;
        }
        
        .waiting-form {
            text-align: left;
            margin-bottom: 24px;
        }
        
        .waiting-form .form-group {
            margin-bottom: 16px;
        }
        
        .waiting-form label {
            display: block;
            font-size: 13px;
            color: var(--gray-400);
            margin-bottom: 6px;
        }
        
        .waiting-form input,
        .waiting-form select {
            width: 100%;
            padding: 12px;
            background: var(--gray-800);
            border: 1px solid var(--gray-700);
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }
        
        .waiting-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: var(--gray-800);
            border-radius: 10px;
            font-size: 13px;
            color: var(--gray-400);
        }
        
        .waiting-status .status-dot {
            width: 8px;
            height: 8px;
            background: #f59e0b;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .waiting-status.host-joined {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }
        
        .waiting-status.host-joined .status-dot {
            background: #22c55e;
            animation: none;
        }
    </style>
</head>
<body class="join-page">
    <!-- Main Join Card -->
    <div class="join-card" id="joinCard">
        <div class="join-logo">ğŸŒ</div>
        <h1 class="join-title">Join Translation Room</h1>
        <p class="join-subtitle">Enter your details to join the real-time translation session</p>
        
        <div class="room-info" id="roomInfo">
            <div class="room-code-display" id="roomCodeDisplay">------</div>
            <div class="room-host" id="roomHost">Loading room info...</div>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <form class="join-form" id="joinForm">
            <div class="form-group">
                <label for="guestName">Your Name</label>
                <input type="text" id="guestName" name="guestName" required placeholder="Enter your name" autocomplete="name">
            </div>
            
            <div class="form-group">
                <label for="guestLanguage">Your Language</label>
                <select id="guestLanguage" name="guestLanguage" required>
                    <option value="">Select your language...</option>
                    <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                    <option value="zh">ğŸ‡¨ğŸ‡³ Chinese (Simplified)</option>
                    <option value="zh-TW">ğŸ‡¹ğŸ‡¼ Chinese (Traditional)</option>
                    <option value="es">ğŸ‡ªğŸ‡¸ Spanish</option>
                    <option value="fr">ğŸ‡«ğŸ‡· French</option>
                    <option value="de">ğŸ‡©ğŸ‡ª German</option>
                    <option value="ja">ğŸ‡¯ğŸ‡µ Japanese</option>
                    <option value="ko">ğŸ‡°ğŸ‡· Korean</option>
                    <option value="pt">ğŸ‡µğŸ‡¹ Portuguese</option>
                    <option value="pt-BR">ğŸ‡§ğŸ‡· Portuguese (Brazil)</option>
                    <option value="it">ğŸ‡®ğŸ‡¹ Italian</option>
                    <option value="ru">ğŸ‡·ğŸ‡º Russian</option>
                    <option value="ar">ğŸ‡¸ğŸ‡¦ Arabic</option>
                    <option value="hi">ğŸ‡®ğŸ‡³ Hindi</option>
                    <option value="bn">ğŸ‡§ğŸ‡© Bengali</option>
                    <option value="pa">ğŸ‡®ğŸ‡³ Punjabi</option>
                    <option value="ta">ğŸ‡®ğŸ‡³ Tamil</option>
                    <option value="te">ğŸ‡®ğŸ‡³ Telugu</option>
                    <option value="mr">ğŸ‡®ğŸ‡³ Marathi</option>
                    <option value="gu">ğŸ‡®ğŸ‡³ Gujarati</option>
                    <option value="ur">ğŸ‡µğŸ‡° Urdu</option>
                    <option value="tr">ğŸ‡¹ğŸ‡· Turkish</option>
                    <option value="nl">ğŸ‡³ğŸ‡± Dutch</option>
                    <option value="pl">ğŸ‡µğŸ‡± Polish</option>
                    <option value="uk">ğŸ‡ºğŸ‡¦ Ukrainian</option>
                    <option value="cs">ğŸ‡¨ğŸ‡¿ Czech</option>
                    <option value="sk">ğŸ‡¸ğŸ‡° Slovak</option>
                    <option value="hu">ğŸ‡­ğŸ‡º Hungarian</option>
                    <option value="ro">ğŸ‡·ğŸ‡´ Romanian</option>
                    <option value="bg">ğŸ‡§ğŸ‡¬ Bulgarian</option>
                    <option value="hr">ğŸ‡­ğŸ‡· Croatian</option>
                    <option value="sr">ğŸ‡·ğŸ‡¸ Serbian</option>
                    <option value="sl">ğŸ‡¸ğŸ‡® Slovenian</option>
                    <option value="el">ğŸ‡¬ğŸ‡· Greek</option>
                    <option value="he">ğŸ‡®ğŸ‡± Hebrew</option>
                    <option value="vi">ğŸ‡»ğŸ‡³ Vietnamese</option>
                    <option value="th">ğŸ‡¹ğŸ‡­ Thai</option>
                    <option value="id">ğŸ‡®ğŸ‡© Indonesian</option>
                    <option value="ms">ğŸ‡²ğŸ‡¾ Malay</option>
                    <option value="tl">ğŸ‡µğŸ‡­ Filipino</option>
                    <option value="fa">ğŸ‡®ğŸ‡· Persian</option>
                    <option value="sw">ğŸ‡°ğŸ‡ª Swahili</option>
                    <option value="af">ğŸ‡¿ğŸ‡¦ Afrikaans</option>
                    <option value="da">ğŸ‡©ğŸ‡° Danish</option>
                    <option value="sv">ğŸ‡¸ğŸ‡ª Swedish</option>
                    <option value="no">ğŸ‡³ğŸ‡´ Norwegian</option>
                    <option value="fi">ğŸ‡«ğŸ‡® Finnish</option>
                    <option value="et">ğŸ‡ªğŸ‡ª Estonian</option>
                    <option value="lv">ğŸ‡±ğŸ‡» Latvian</option>
                    <option value="lt">ğŸ‡±ğŸ‡¹ Lithuanian</option>
                    <option value="ca">ğŸ‡ªğŸ‡¸ Catalan</option>
                    <option value="eu">ğŸ‡ªğŸ‡¸ Basque</option>
                    <option value="gl">ğŸ‡ªğŸ‡¸ Galician</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-primary join-btn" id="joinBtn">
                <span>Join Room</span>
            </button>
        </form>
        
        <div class="join-features">
            <div class="feature-item">
                <span class="icon">âœ“</span>
                <span>No signup required</span>
            </div>
            <div class="feature-item">
                <span class="icon">âœ“</span>
                <span>Real-time translation</span>
            </div>
            <div class="feature-item">
                <span class="icon">âœ“</span>
                <span>Video included</span>
            </div>
        </div>
        
        <div class="powered-by">
            Powered by <a href="index.html">Mamnoon.ai</a>
        </div>
    </div>
    
    <!-- Room Not Found Card -->
    <div class="join-card room-not-found" id="notFoundCard" style="display: none;">
        <div class="icon">ğŸ”</div>
        <h2>Room Not Found</h2>
        <p>This room doesn't exist or has ended. Enter a room code to join:</p>
        
        <form class="enter-code-form" id="enterCodeForm">
            <input type="text" id="manualCode" placeholder="ABC123" maxlength="6" required>
            <button type="submit" class="btn btn-primary">Join</button>
        </form>
        
        <div class="powered-by">
            Want to host your own? <a href="signup.html">Sign up free</a>
        </div>
    </div>

    <!-- Waiting Lobby Card -->
    <div class="join-card waiting-lobby" id="waitingCard" style="display: none;">
        <div class="waiting-animation">
            <div class="waiting-icon">â³</div>
            <div class="pulse-ring"></div>
        </div>
        <h2>Waiting for Host</h2>
        <p id="waitingMessage">The host hasn't started the meeting yet. You'll join automatically when they arrive.</p>
        <div class="host-info">
            <span>Host: </span>
            <span id="waitingHostName">---</span>
        </div>
        <div class="room-code-badge">
            Room: <span id="waitingRoomCode">------</span>
        </div>
        <div class="waiting-form">
            <div class="form-group">
                <label for="waitingName">Your Name</label>
                <input type="text" id="waitingName" placeholder="Enter your name" required>
            </div>
            <div class="form-group">
                <label for="waitingLanguage">Your Language</label>
                <select id="waitingLanguage" required>
                    <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                    <option value="es">ğŸ‡ªğŸ‡¸ Spanish</option>
                    <option value="zh">ğŸ‡¨ğŸ‡³ Chinese</option>
                    <option value="fr">ğŸ‡«ğŸ‡· French</option>
                    <option value="de">ğŸ‡©ğŸ‡ª German</option>
                    <option value="ja">ğŸ‡¯ğŸ‡µ Japanese</option>
                    <option value="ko">ğŸ‡°ğŸ‡· Korean</option>
                    <option value="ar">ğŸ‡¸ğŸ‡¦ Arabic</option>
                    <option value="pt">ğŸ‡§ğŸ‡· Portuguese</option>
                    <option value="ru">ğŸ‡·ğŸ‡º Russian</option>
                    <option value="hi">ğŸ‡®ğŸ‡³ Hindi</option>
                    <option value="it">ğŸ‡®ğŸ‡¹ Italian</option>
                    <option value="nl">ğŸ‡³ğŸ‡± Dutch</option>
                    <option value="tr">ğŸ‡¹ğŸ‡· Turkish</option>
                    <option value="fa">ğŸ‡®ğŸ‡· Persian</option>
                    <option value="da">ğŸ‡©ğŸ‡° Danish</option>
                </select>
            </div>
        </div>
        <div class="waiting-status" id="waitingStatus">
            <span class="status-dot"></span>
            <span>Checking for host...</span>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        // Get room code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const pathParts = window.location.pathname.split('/');
        let roomCode = urlParams.get('code') || urlParams.get('room') || pathParts[pathParts.length - 1];
        
        // Clean up room code
        if (roomCode && roomCode.includes('.')) {
            roomCode = roomCode.split('.')[0]; // Remove .html if present
        }
        if (roomCode) {
            roomCode = roomCode.toUpperCase().replace(/[^A-Z0-9]/g, '');
        }
        
        const joinCard = document.getElementById('joinCard');
        const notFoundCard = document.getElementById('notFoundCard');
        const waitingCard = document.getElementById('waitingCard');
        const errorMessage = document.getElementById('errorMessage');
        
        // Check if room exists
        async function checkRoom() {
            if (!roomCode || roomCode.length < 4) {
                showNotFound();
                return;
            }
            
            document.getElementById('roomCodeDisplay').textContent = roomCode;
            document.getElementById('roomHost').textContent = 'Verifying room...';
            
            try {
                // First check if this is a personal room
                const personalCheck = await fetch(`${CONFIG.API_BASE}/api/personal-room/check/${roomCode}`);
                const personalData = await personalCheck.json();
                
                if (personalData.exists) {
                    // It's a personal room
                    if (personalData.host_present) {
                        // Host is there, show regular join form
                        document.getElementById('roomHost').textContent = `${personalData.host_name}'s room â€¢ Ready to join`;
                    } else {
                        // Host not there, show waiting lobby
                        showWaitingLobby(personalData.host_name, roomCode);
                        return;
                    }
                } else {
                    // Not a personal room, try regular room check
                    const response = await fetch(`${CONFIG.API_BASE}/api/room/join/${roomCode}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_name: 'checking',
                            language: 'en'
                        })
                    });
                    
                    if (response.ok) {
                        document.getElementById('roomHost').textContent = 'Room is active â€¢ Ready to join';
                    } else {
                        showNotFound();
                    }
                }
            } catch (error) {
                showNotFound();
            }
        }
        
        function showNotFound() {
            joinCard.style.display = 'none';
            notFoundCard.style.display = 'block';
            waitingCard.style.display = 'none';
        }
        
        function showWaitingLobby(hostName, code) {
            joinCard.style.display = 'none';
            notFoundCard.style.display = 'none';
            waitingCard.style.display = 'block';
            
            document.getElementById('waitingHostName').textContent = hostName;
            document.getElementById('waitingRoomCode').textContent = code;
            
            // Start polling for host
            startPolling(code);
        }
        
        let pollingInterval = null;
        
        function startPolling(code) {
            // Check every 5 seconds if host has joined
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${CONFIG.API_BASE}/api/personal-room/check/${code}`);
                    const data = await response.json();
                    
                    if (data.host_present) {
                        clearInterval(pollingInterval);
                        
                        // Update status
                        const statusDiv = document.getElementById('waitingStatus');
                        statusDiv.className = 'waiting-status host-joined';
                        statusDiv.innerHTML = '<span class="status-dot"></span><span>Host has joined! Connecting...</span>';
                        
                        // Auto-join after a short delay
                        setTimeout(() => {
                            autoJoinRoom(code);
                        }, 1500);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 5000);
        }
        
        async function autoJoinRoom(code) {
            const name = document.getElementById('waitingName').value.trim() || 'Guest';
            const language = document.getElementById('waitingLanguage').value || 'en';
            
            try {
                const response = await fetch(`${CONFIG.API_BASE}/api/room/join/${code}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_name: name,
                        language: language
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const guestSession = {
                        id: data.user_id,
                        name: name,
                        isGuest: true
                    };
                    sessionStorage.setItem('guestUser', JSON.stringify(guestSession));
                    sessionStorage.setItem('guestRoom', JSON.stringify({
                        code: code,
                        language: language,
                        videoUrl: data.video_url
                    }));
                    
                    window.location.href = `app.html?guest=true&room=${code}&name=${encodeURIComponent(name)}&lang=${language}`;
                }
            } catch (error) {
                console.error('Auto-join failed:', error);
            }
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        // Join form submission
        document.getElementById('joinForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('guestName').value.trim();
            const language = document.getElementById('guestLanguage').value;
            const btn = document.getElementById('joinBtn');
            
            if (!name || !language) {
                showError('Please fill in all fields');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Joining...';
            errorMessage.style.display = 'none';
            
            try {
                const response = await fetch(`${CONFIG.API_BASE}/api/room/join/${roomCode}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_name: name,
                        language: language
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Store guest session
                    const guestSession = {
                        id: data.user_id,
                        name: name,
                        isGuest: true
                    };
                    sessionStorage.setItem('guestUser', JSON.stringify(guestSession));
                    sessionStorage.setItem('guestRoom', JSON.stringify({
                        code: roomCode,
                        language: language,
                        videoUrl: data.video_url
                    }));
                    
                    // Redirect to app with guest mode
                    window.location.href = `app.html?guest=true&room=${roomCode}&lang=${language}&name=${encodeURIComponent(name)}`;
                } else {
                    showError(data.detail || 'Failed to join room');
                    btn.disabled = false;
                    btn.innerHTML = '<span>Join Room</span>';
                }
            } catch (error) {
                showError('Connection error. Please try again.');
                btn.disabled = false;
                btn.innerHTML = '<span>Join Room</span>';
            }
        });
        
        // Manual code entry
        document.getElementById('enterCodeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const code = document.getElementById('manualCode').value.trim().toUpperCase();
            if (code.length === 6) {
                window.location.href = `join.html?code=${code}`;
            }
        });
        
        // Auto-uppercase manual code input
        document.getElementById('manualCode').addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
        
        // Try to detect browser language
        const browserLang = navigator.language.split('-')[0];
        const langSelect = document.getElementById('guestLanguage');
        if (langSelect.querySelector(`option[value="${browserLang}"]`)) {
            langSelect.value = browserLang;
        }
        
        // Init
        checkRoom();
    </script>
</body>
</html>
